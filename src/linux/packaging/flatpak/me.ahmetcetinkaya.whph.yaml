app-id: me.ahmetcetinkaya.whph
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: whph
separate-locales: false
build-options:
  env:
    CPATH: /app/include:/app/include/libayatana-ido3-0.4:/app/include/libayatana-indicator3-0.4

finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --share=network
  - --talk-name=org.freedesktop.portal.Desktop
  - --talk-name=org.freedesktop.portal.Documents
  - --talk-name=org.freedesktop.portal.Settings
  - --talk-name=org.freedesktop.impl.portal.desktop.*
  - --filesystem=xdg-config/gtk-3.0:ro
  - --filesystem=xdg-config/gtk-4.0:ro
  - --filesystem=xdg-config/fontconfig:ro
  - --filesystem=xdg-config/kdeglobals:ro
  - --env=GSETTINGS_BACKEND=dconf
  - --talk-name=org.freedesktop.Settings
modules:
  - name: perl-xml-parser
    buildsystem: simple
    build-commands:
      - perl Makefile.PL PREFIX=/app
      - make
      - make install
    post-install:
      - chmod -R u+w /app/lib/perl5
    sources:
      - type: archive
        url: https://cpan.metacpan.org/authors/id/T/TO/TODDR/XML-Parser-2.44.tar.gz
        sha256: 1ae9d07ee9c35326b3d9aad56eae71a6730a73a116b9fe9e8a4758b7cc033216

  - name: intltool
    buildsystem: autotools
    sources:
      - type: archive
        url: https://launchpad.net/intltool/trunk/0.51.0/+download/intltool-0.51.0.tar.gz
        sha256: 67c74d94196b153b774ab9f89b2fa6c6ba79352407037c8c14d5aeb334e959cd

  - name: libdbusmenu
    buildsystem: autotools
    build-options:
      cflags: -Wno-error
    config-opts:
      - --disable-nls
      - --disable-dumper
      - --disable-introspection
      - --disable-vala
    sources:
      - type: archive
        url: https://launchpad.net/libdbusmenu/16.04/16.04.0/+download/libdbusmenu-16.04.0.tar.gz
        sha256: b9cc4a2acd74509435892823607d966d424bd9ad5d0b00938f27240a1bfa878a

  - name: ayatana-ido
    buildsystem: simple
    build-commands:
      - |
        find . -name CMakeLists.txt -exec sed -i 's/find_package(Vala/message(STATUS SkippingVala) #/' {} +
        # Neutralize introspection scanner calls if any
        find . -name CMakeLists.txt -exec sed -i 's/gobject_introspection_add_gir/message(STATUS SkippingGIR) #/g' {} +
        find . -name CMakeLists.txt -exec sed -i 's/introspection_add_gir/message(STATUS SkippingGIR) #/g' {} +
      - mkdir build
      - cd build && cmake -G Ninja .. -DCMAKE_INSTALL_PREFIX=/app -DCMAKE_INSTALL_LIBDIR=lib -DCMAKE_BUILD_TYPE=Release -DENABLE_TESTS=OFF
      - ninja -C build
      - |
        # Create dummy files to satisfy install rules
        mkdir -p build/src
        touch build/src/AyatanaIdo3-0.4.gir
        touch build/src/AyatanaIdo3-0.4.typelib
      - ninja -C build install
      - |
        # Fix header paths for downstream modules
        ID_SRC=$(find /app/include -name libayatana-ido -type d | grep libayatana-ido3-0.4 || true)
        if [ -n "$ID_SRC" ]; then
          mkdir -p /app/include/libayatana-ido
          cp -r "$ID_SRC"/. /app/include/libayatana-ido/
        fi
    sources:
      - type: archive
        url: https://github.com/AyatanaIndicators/ayatana-ido/archive/refs/tags/0.10.4.tar.gz
        sha256: bd59abd5f1314e411d0d55ce3643e91cef633271f58126be529de5fb71c5ab38

  - name: libayatana-indicator
    buildsystem: simple
    build-commands:
      - |
        find . -name CMakeLists.txt -exec sed -i 's/find_package(Vala/message(STATUS SkippingVala) #/' {} +
        find . -name CMakeLists.txt -exec sed -i 's/gobject_introspection_add_gir/message(STATUS SkippingGIR) #/g' {} +
        find . -name CMakeLists.txt -exec sed -i 's/introspection_add_gir/message(STATUS SkippingGIR) #/g' {} +
      - mkdir build
      - cd build && cmake -G Ninja .. -DCMAKE_INSTALL_PREFIX=/app -DCMAKE_INSTALL_LIBDIR=lib -DCMAKE_BUILD_TYPE=Release -DENABLE_TESTS=OFF -DENABLE_LOADER_USE_RPATH=ON
      - ninja -C build
      - |
        mkdir -p build/src
        touch build/src/AyatanaIndicator3-0.4.gir
        touch build/src/AyatanaIndicator3-0.4.typelib
      - ninja -C build install
    sources:
      - type: archive
        url: https://github.com/AyatanaIndicators/libayatana-indicator/archive/0.9.4.tar.gz
        sha256: a18d3c682e29afd77db24366f8475b26bda22b0e16ff569a2ec71cd6eb4eac95

  - name: libayatana-appindicator
    buildsystem: simple
    build-commands:
      - |
        find . -name CMakeLists.txt -exec sed -i 's/find_package(Vala/message(STATUS SkippingVala) #/' {} +
        find . -name CMakeLists.txt -exec sed -i 's/gobject_introspection_add_gir/message(STATUS SkippingGIR) #/g' {} +
        find . -name CMakeLists.txt -exec sed -i 's/introspection_add_gir/message(STATUS SkippingGIR) #/g' {} +
      - mkdir build
      - cd build && cmake -G Ninja .. -DCMAKE_INSTALL_PREFIX=/app -DCMAKE_INSTALL_LIBDIR=lib -DCMAKE_BUILD_TYPE=Release -DENABLE_TESTS=OFF -DENABLE_BINDINGS_MONO=OFF -DENABLE_BINDINGS_VALA=OFF
      - ninja -C build
      - |
        mkdir -p build/src
        touch build/src/AyatanaAppIndicator3-0.1.gir
        touch build/src/AyatanaAppIndicator3-0.1.typelib
      - ninja -C build install
    sources:
      - type: archive
        url: https://github.com/AyatanaIndicators/libayatana-appindicator/archive/0.5.91.tar.gz
        sha256: 52eb5d0c0de07177833e50fbaee592dcb3939e96c6b789921e2a8caf40a1ed26

  - name: whph
    buildsystem: simple
    build-commands:
      - install -D whph /app/bin/whph
      - mkdir -p /app/bin/data /app/bin/lib
      - cp -r data/flutter_assets /app/bin/data/flutter_assets
      - cp -a lib/. /app/bin/lib/
      - install -D data/icudtl.dat /app/bin/data/icudtl.dat
      - install -D share/applications/whph.desktop /app/share/applications/me.ahmetcetinkaya.whph.desktop
      - install -D share/icons/hicolor/512x512/apps/whph.png /app/share/icons/hicolor/512x512/apps/me.ahmetcetinkaya.whph.png
      - install -D share/dbus-1/services/whph.service /app/share/dbus-1/services/me.ahmetcetinkaya.whph.service
    sources:
      - type: dir
        path: ../../../../src/build/linux/x64/release/bundle
