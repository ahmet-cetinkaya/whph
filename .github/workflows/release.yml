name: Release All Platforms

on:
  workflow_dispatch: # Manual trigger
  workflow_run:
    workflows:
      - "Flutter CI - Android"
      - "Flutter CI - Linux"
      - "Flutter CI - Windows"
    types:
      - completed

jobs:
  check-workflows:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && startsWith(github.event.workflow_run.head_branch, 'v')) }}
    outputs:
      should-release: ${{ steps.check.outputs.should-release }}
      tag-name: ${{ steps.check.outputs.tag-name }}
      tag-version: ${{ steps.check.outputs.tag-version }}
      app-version: ${{ steps.check.outputs.app-version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          submodules: false

      - name: Initialize Submodules
        uses: ./.github/actions/setup-repository

      - name: Get application version
        id: app_version
        uses: ./.github/actions/get-app-version

      - name: Check if all workflows completed successfully
        id: check
        run: |
          # Extract tag info from the head branch or use current branch for manual dispatch
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            HEAD_BRANCH="${{ github.ref_name }}"
            echo "Manual dispatch - using current branch: $HEAD_BRANCH"
          else
            HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
            echo "Workflow run - using head branch: $HEAD_BRANCH"
          fi

          # For manual dispatch, skip tag validation and use app version directly
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual dispatch - release with current app version
            APP_VERSION="${{ steps.app_version.outputs.version }}"
            TAG_NAME="v${{ steps.app_version.outputs.version-number }}"
            TAG_VERSION="${{ steps.app_version.outputs.version-number }}"
            
            echo "tag-name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "tag-version=$TAG_VERSION" >> $GITHUB_OUTPUT
            echo "app-version=$APP_VERSION" >> $GITHUB_OUTPUT
            echo "should-release=true" >> $GITHUB_OUTPUT
            
            echo "üéâ Manual release for version $APP_VERSION"
            
          elif [[ $HEAD_BRANCH =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            TAG_NAME="$HEAD_BRANCH"
            TAG_VERSION="${TAG_NAME#v}"
            echo "tag-name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "tag-version=$TAG_VERSION" >> $GITHUB_OUTPUT
            
            # Use app version from the composite action
            APP_VERSION="${{ steps.app_version.outputs.version }}"
            echo "app-version=$APP_VERSION" >> $GITHUB_OUTPUT
            
            # Check if all three workflows have completed successfully for this tag
            WORKFLOWS=("Flutter CI - Android" "Flutter CI - Linux" "Flutter CI - Windows")
            ALL_SUCCESS=true
            
            for workflow in "${WORKFLOWS[@]}"; do
              echo "Checking workflow: $workflow"
              LATEST_RUN=$(gh run list --workflow="$workflow" --limit=5 --json status,conclusion,headBranch --jq ".[] | select(.headBranch == \"$TAG_NAME\")" | head -1)
              
              if [[ -n "$LATEST_RUN" ]]; then
                STATUS=$(echo "$LATEST_RUN" | jq -r '.status')
                CONCLUSION=$(echo "$LATEST_RUN" | jq -r '.conclusion')
                
                echo "  Status: $STATUS, Conclusion: $CONCLUSION"
                
                if [[ "$STATUS" != "completed" ]] || [[ "$CONCLUSION" != "success" ]]; then
                  echo "  ‚ùå Workflow $workflow not ready"
                  ALL_SUCCESS=false
                  break
                else
                  echo "  ‚úÖ Workflow $workflow completed successfully"
                fi
              else
                echo "  ‚ùå No run found for workflow $workflow with tag $TAG_NAME"
                ALL_SUCCESS=false
                break
              fi
            done
            
            if [[ "$ALL_SUCCESS" == "true" ]]; then
              echo "should-release=true" >> $GITHUB_OUTPUT
              echo "üéâ All workflows completed successfully for tag $TAG_NAME"
            else
              echo "should-release=false" >> $GITHUB_OUTPUT
              echo "‚è≥ Not all workflows completed successfully yet"
            fi
          else
            echo "should-release=false" >> $GITHUB_OUTPUT
            echo "‚ùå Not a tag push (branch: $HEAD_BRANCH)"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    needs: check-workflows
    runs-on: ubuntu-latest
    if: ${{ needs.check-workflows.outputs.should-release == 'true' }}
    permissions:
      contents: write
    outputs:
      tag-name: ${{ steps.set_outputs.outputs.tag-name }}
      tag-version: ${{ steps.set_outputs.outputs.tag-version }}
      app-version: ${{ steps.set_outputs.outputs.app-version }}
    steps:
      - name: Set job outputs
        id: set_outputs
        run: |
          echo "tag-name=${{ needs.check-workflows.outputs.tag-name }}" >> $GITHUB_OUTPUT
          echo "tag-version=${{ needs.check-workflows.outputs.tag-version }}" >> $GITHUB_OUTPUT
          echo "app-version=${{ needs.check-workflows.outputs.app-version }}" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          submodules: false

      - name: Initialize Submodules
        uses: ./.github/actions/setup-repository

      - name: Download all artifacts from completed workflows
        run: |
          TAG_NAME="${{ needs.check-workflows.outputs.tag-name }}"
          APP_VERSION="${{ needs.check-workflows.outputs.app-version }}"

          echo "Downloading artifacts for tag: $TAG_NAME, app version: $APP_VERSION"

          # Download artifacts from each workflow
          WORKFLOWS=("Flutter CI - Android" "Flutter CI - Linux" "Flutter CI - Windows")

          for workflow in "${WORKFLOWS[@]}"; do
            echo "Downloading artifacts from: $workflow"
            
            # For manual dispatch, get latest successful run regardless of branch
            if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
              echo "  Manual dispatch - getting latest successful run"
              RUN_ID=$(gh run list --workflow="$workflow" --limit=10 --json databaseId,conclusion --jq ".[] | select(.conclusion == \"success\") | .databaseId" | head -1)
            else
              # For automatic runs, check for specific tag
              echo "  Automatic run - checking for tag: $TAG_NAME"
              RUN_ID=$(gh run list --workflow="$workflow" --limit=10 --json databaseId,headBranch,conclusion --jq ".[] | select(.headBranch == \"$TAG_NAME\" and .conclusion == \"success\") | .databaseId" | head -1)
            fi
            
            if [[ -n "$RUN_ID" ]]; then
              echo "  Found run ID: $RUN_ID"
              gh run download "$RUN_ID" --dir artifacts/
            else
              echo "  ‚ùå No successful run found for $workflow"
              echo "  Available runs:"
              gh run list --workflow="$workflow" --limit=5 --json databaseId,headBranch,conclusion
              exit 1
            fi
          done

          echo "Downloaded artifacts:"
          find artifacts/ -type f -exec ls -la {} \;
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare release files
        run: |
          TAG_VERSION="${{ needs.check-workflows.outputs.tag-version }}"
          APP_VERSION="${{ needs.check-workflows.outputs.app-version }}"

          echo "Preparing release files for version: $TAG_VERSION"

          # Prepare Android APK
          if [[ -f "artifacts/whph-v$APP_VERSION-android/app-release.apk" ]]; then
            mv "artifacts/whph-v$APP_VERSION-android/app-release.apk" "whph-v$TAG_VERSION-android.apk"
            echo "‚úÖ Android APK prepared"
          else
            echo "‚ùå Android APK not found"
            exit 1
          fi

          # Create Linux tar.gz archive
          if [[ -d "artifacts/whph-v$APP_VERSION-linux" ]]; then
            cd "artifacts/whph-v$APP_VERSION-linux"
            tar -czf "../../whph-v$TAG_VERSION-linux.tar.gz" .
            cd ../..
            echo "‚úÖ Linux tar.gz created"
          else
            echo "‚ùå Linux build directory not found"
            exit 1
          fi

          # Create Windows portable zip archive
          if [[ -d "artifacts/whph-v$APP_VERSION-windows-portable" ]]; then
            cd "artifacts/whph-v$APP_VERSION-windows-portable"
            zip -r "../../whph-v$TAG_VERSION-windows-portable.zip" .
            cd ../..
            echo "‚úÖ Windows portable zip created"
          else
            echo "‚ùå Windows portable build directory not found"
            exit 1
          fi

          # Prepare Windows installer
          if [[ -f "artifacts/whph-v$APP_VERSION-windows-installer/whph-setup.exe" ]]; then
            cp "artifacts/whph-v$APP_VERSION-windows-installer/whph-setup.exe" "whph-v$TAG_VERSION-windows-setup.exe"
            echo "‚úÖ Windows installer prepared"
          else
            echo "‚ùå Windows installer not found"
            exit 1
          fi

          # Prepare Linux Flatpak
          if [[ -f "artifacts/whph-v$APP_VERSION-flatpak/whph.flatpak" ]]; then
            cp "artifacts/whph-v$APP_VERSION-flatpak/whph.flatpak" "whph-v$TAG_VERSION.flatpak"
            echo "‚úÖ Linux Flatpak prepared"
          else
            echo "‚ö†Ô∏è Linux Flatpak not found"
          fi

          echo "üì¶ All release files prepared:"
          ls -la whph-v$TAG_VERSION-*

      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            whph-v${{ needs.check-workflows.outputs.tag-version }}-android.apk
            whph-v${{ needs.check-workflows.outputs.tag-version }}-linux.tar.gz
            whph-v${{ needs.check-workflows.outputs.tag-version }}.flatpak
            whph-v${{ needs.check-workflows.outputs.tag-version }}-windows-portable.zip
            whph-v${{ needs.check-workflows.outputs.tag-version }}-windows-setup.exe
          name: ${{ needs.check-workflows.outputs.tag-name }}
          tag_name: ${{ needs.check-workflows.outputs.tag-name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ### Downloads:
            - `whph-v${{ needs.check-workflows.outputs.tag-version }}-android.apk` - Android APK
            - `whph-v${{ needs.check-workflows.outputs.tag-version }}-linux.tar.gz` - Linux portable 
              > üêß Linux portable users: See [LINUX-DEPENDENCIES.md](https://github.com/ahmet-cetinkaya/whph/blob/${{ needs.check-workflows.outputs.tag-name }}/docs/LINUX-DEPENDENCIES.md) for system requirements and installation instructions.
            - `whph-v${{ needs.check-workflows.outputs.tag-version }}.flatpak` - Linux Flatpak bundle
            - `whph-v${{ needs.check-workflows.outputs.tag-version }}-windows-portable.zip` - Windows portable  
            - `whph-v${{ needs.check-workflows.outputs.tag-version }}-windows-setup.exe` - Windows installer

            > [!NOTE]
            > üìã See [CHANGELOG.md](https://github.com/ahmet-cetinkaya/whph/blob/${{ needs.check-workflows.outputs.tag-name }}/CHANGELOG.md) for detailed changes.

  update-aur:
    needs: release
    runs-on: ubuntu-latest
    container: archlinux:latest
    permissions:
      contents: write
    steps:
      - name: Install dependencies
        run: pacman -Syu --noconfirm git base-devel pacman-contrib openssh sudo

      - name: Fix git ownership
        run: git config --system --add safe.directory '*'

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Update AUR
        run: ./scripts/update_aur.sh

      - name: Commit and push AUR submodule changes in parent repo
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          
          CURRENT_VERSION=$(grep "^version:" src/pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          
          # Add the submodule directory to stage the pointer change
          git add packaging/aur
          
          if [[ -n "$(git status --porcelain packaging/aur)" ]]; then
            git commit -m "chore(aur): update aur submodule pointer to v$CURRENT_VERSION"
            git pull --rebase
            git push
            echo "‚úÖ Parent repository submodule pointer updated for AUR"
          else
            echo "‚ÑπÔ∏è No submodule pointer change detected in parent repository for AUR"
          fi

  update-nix:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Update Nix Package
        run: ./scripts/update_nix.sh

  update-flathub:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Download Flathub manifest artifact
        run: |
          TAG_NAME="${{ needs.release.outputs.tag-name }}"
          APP_VERSION="${{ needs.release.outputs.app-version }}"
          
          # Find and download the flathub manifest artifact
          RUN_ID=$(gh run list --workflow="Flutter CI - Linux" --limit=10 --json databaseId,headBranch,conclusion --jq ".[] | select(.headBranch == \"$TAG_NAME\" and .conclusion == \"success\") | .databaseId" | head -1)
          
          if [[ -n "$RUN_ID" ]]; then
            echo "Found run ID: $RUN_ID"
            gh run download "$RUN_ID" --dir flathub-artifact/ -n "whph-v${APP_VERSION}-flathub-manifest"
            echo "Downloaded flathub manifest artifact"
          else
            echo "‚ùå No successful run found for Flutter CI - Linux with tag $TAG_NAME"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy flathub manifest files
        run: |
          # Copy the manifest files to the submodule directory
          cp flathub-artifact/me.ahmetcetinkaya.whph.yaml packaging/flatpak/flathub/
          cp -r flathub-artifact/generated packaging/flatpak/flathub/
          echo "Copied flathub manifest files to submodule"

      - name: Update Flathub
        run: |
          cd packaging/flatpak/flathub
          
          # In the submodule: fetch, checkout, and hard reset to ensure absolute sync with the branch
          git fetch origin me.ahmetcetinkaya.whph
          git checkout me.ahmetcetinkaya.whph
          git reset --hard origin/me.ahmetcetinkaya.whph
          
          # Unset the extraheader set by actions/checkout for this submodule so PAT can be used
          git config --local --unset-all http.https://github.com/.extraheader || true
          
          # Configure git to use PAT for authentication with the submodule remote
          git remote set-url origin https://${FLATHUB_PAT}@github.com/ahmet-cetinkaya/flathub.git
          
          cd "$GITHUB_WORKSPACE"
          ./scripts/update_flathub.sh
        env:
          FLATHUB_PAT: ${{ secrets.FLATHUB_PAT }}

      - name: Commit and push flathub submodule changes
        run: |
          TAG_NAME="${{ needs.release.outputs.tag-name }}"
          cd packaging/flatpak/flathub

          # Unset the extraheader set by actions/checkout for this submodule so PAT can be used
          git config --local --unset-all http.https://github.com/.extraheader || true

          # Check if there are changes to commit in the submodule
          if [[ -n "$(git status --porcelain)" ]]; then
            git add .
            git commit -m "Update manifest for $TAG_NAME"
            git pull --rebase origin me.ahmetcetinkaya.whph
            git push origin HEAD:me.ahmetcetinkaya.whph
            echo "‚úÖ Flathub submodule changes pushed successfully"
          else
            echo "‚ÑπÔ∏è No changes to commit in flathub submodule"
          fi

          # Commit the submodule change in the parent repository
          cd "$GITHUB_WORKSPACE"
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          
          # Add the submodule directory to stage the pointer change
          git add packaging/flatpak/flathub
          
          if [[ -n "$(git status --porcelain packaging/flatpak/flathub)" ]]; then
            git commit -m "chore(flatpak): update flathub submodule pointer to $TAG_NAME"
            git pull --rebase
            git push
            echo "‚úÖ Parent repository submodule pointer updated"
          else
            echo "‚ÑπÔ∏è No submodule pointer change detected in parent repository"
          fi
        env:
          FLATHUB_PAT: ${{ secrets.FLATHUB_PAT }}
