name: Flutter CI - Windows

on:
  workflow_dispatch: # This is a trigger for manual workflow run
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Initialize Submodules
        uses: ./.github/actions/setup-repository

      - name: Setup Flutter with FVM
        uses: ./.github/actions/setup-fvm
        with:
          cache-key-suffix: "windows"

      - name: Setup Visual Studio tools
        uses: microsoft/setup-msbuild@v2

      - name: Install Inno Setup
        run: |
          Write-Host "Installing Inno Setup..."
          $url = "https://jrsoftware.org/download.php/is.exe"
          $output = "$env:TEMP\innosetup.exe"
          try {
            Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
            Start-Process -FilePath $output -ArgumentList "/VERYSILENT", "/NORESTART" -Wait
            echo "C:\Program Files (x86)\Inno Setup 6" >> $env:GITHUB_PATH
            Write-Host "Inno Setup installed successfully"
          } catch {
            Write-Host "Failed to install Inno Setup: $($_.Exception.Message)"
            exit 1
          }

      - name: Install Flutter Dependencies
        uses: ./.github/actions/install-flutter-deps
        with:
          enable-platform: windows-desktop

      - name: Install RPS and generate code
        shell: bash
        run: |
          fvm dart pub global activate rps
          fvm dart pub global run rps:rps gen

      - name: Check plugin compatibility
        run: |
          Write-Host "Checking for plugin compatibility..."
          cd src
          fvm flutter pub deps

      - name: Clean previous builds
        run: |
          cd src
          fvm flutter clean

      # Add workaround for flutter_local_notifications_windows AOT issue
      - name: Apply Windows build workarounds
        run: |
          Write-Host "Applying workarounds for Windows build issues..."

          # Check if the problematic plugin exists
          Write-Host "Checking for flutter_local_notifications_windows plugin..."
          if (Test-Path "src/pubspec.lock") {
            $pubspecLock = Get-Content "src/pubspec.lock" -Raw
            if ($pubspecLock -match "flutter_local_notifications_windows") {
              Write-Host "Found flutter_local_notifications_windows plugin - applying AOT workarounds"
              
              # Set environment variables to help with AOT compilation
              echo "FLUTTER_AOT_WORKAROUND=true" >> $env:GITHUB_ENV
              echo "FLUTTER_DISABLE_TREE_SHAKE=true" >> $env:GITHUB_ENV
              echo "FLUTTER_LOCAL_NOTIFICATIONS_DETECTED=true" >> $env:GITHUB_ENV
              
              Write-Host "Plugin version information:"
              Select-String -Path "src/pubspec.lock" -Pattern "flutter_local_notifications" -Context 5
            } else {
              Write-Host "flutter_local_notifications_windows plugin not found"
            }
          } else {
            Write-Host "src/pubspec.lock not found"
          }

          Write-Host "Setting additional build environment variables..."
          # These flags may help with the AOT compilation issue
          echo "FLUTTER_BUILD_MODE=release" >> $env:GITHUB_ENV

      - name: Build for Windows
        run: |
          Write-Host "üîß Configuring Windows build environment..."
          cd src
          fvm flutter config --enable-windows-desktop
          fvm flutter clean
          fvm flutter pub get

          # Strategy 1: Standard release build
          Write-Host "üì¶ Building Windows application (Release mode)..."
          fvm flutter build windows --release
          if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Release build succeeded!"
            echo "BUILD_TYPE=Release" >> $env:GITHUB_ENV
          } else {
            Write-Host "‚ùå Release build failed, trying profile mode..."
            
            # Strategy 2: Profile build as fallback
            fvm flutter build windows --profile
            if ($LASTEXITCODE -eq 0) {
              Write-Host "‚úÖ Profile build succeeded!"
              echo "BUILD_TYPE=Profile" >> $env:GITHUB_ENV
            } else {
              Write-Host "‚ùå Build failed with exit code: $LASTEXITCODE"
              exit 1
            }
          }

          # Verify BUILD_TYPE was set
          if (-not $env:BUILD_TYPE) {
            Write-Host "‚ö†Ô∏è  WARNING: BUILD_TYPE not set, defaulting to Release"
            echo "BUILD_TYPE=Release" >> $env:GITHUB_ENV
          }

          Write-Host "‚úÖ Build completed successfully (BUILD_TYPE: $env:BUILD_TYPE)"
        env:
          FLUTTER_BUILD_DIR: build

      - name: Debug build output on failure
        if: failure()
        run: |
          Write-Host "Build failed. Checking for build logs..."
          if (Test-Path "src/build/") {
            Get-ChildItem -Path "src/build/" -Recurse
          } else {
            Write-Host "No build directory found"
          }
          if (Test-Path "src/build/windows/") {
            Get-ChildItem -Path "src/build/windows/" -Recurse
          } else {
            Write-Host "No windows build directory found"
          }
          Write-Host "Checking for log files..."
          $logFiles = Get-ChildItem -Path "src/build/" -Recurse -Filter "*.log" -ErrorAction SilentlyContinue
          if ($logFiles) {
            foreach ($file in $logFiles) {
              Write-Host "=== Contents of $($file.FullName) ==="
              Get-Content $file.FullName
            }
          } else {
            Write-Host "No log files found"
          }

      # Publish the build artifacts
      - name: Check build output
        run: |
          Write-Host "BUILD_TYPE: ${{ env.BUILD_TYPE }}"
          if (Test-Path "src/build/windows/x64/runner/${{ env.BUILD_TYPE }}") {
            Write-Host "‚úÖ Build output found"
          } else {
            Write-Host "‚ùå Build output missing"
            exit 1
          }

      - name: Verify build output
        run: |
          $buildPath = "src\build\windows\x64\runner\${{ env.BUILD_TYPE }}"
          if (Test-Path $buildPath) {
            $fileCount = (Get-ChildItem -Path $buildPath -Recurse -File).Count
            Write-Host "‚úÖ Build verified: $fileCount files in $buildPath"
          } else {
            Write-Host "‚ùå Build folder not found: $buildPath"
            exit 1
          }

      - name: Create Windows Installer
        run: |
          Write-Host "Creating Windows installer with Inno Setup..."

          # Get app version for the installer
          $content = Get-Content 'src/pubspec.yaml'
          $version = $content | Select-String 'version: (.*)' | ForEach-Object { $_.Matches.Groups[1].Value.Split('+')[0] }
          Write-Host "App version: $version"

          # Verify the build output exists
          $buildPath = "src\build\windows\x64\runner\${{ env.BUILD_TYPE }}"
          Write-Host "Checking build output at: $buildPath"
          if (-not (Test-Path $buildPath)) {
            Write-Host "ERROR: Build output not found at $buildPath"
            Write-Host "Available build directories:"
            if (Test-Path "src\build\windows\x64\runner") {
              Get-ChildItem "src\build\windows\x64\runner" | ForEach-Object { Write-Host "  - $($_.Name)" }
            }
            exit 1
          }

          # Create installer directory in the correct location
          $installerDir = "src\build\windows\installer"
          New-Item -ItemType Directory -Force -Path $installerDir
          Write-Host "Created installer directory: $installerDir"

          # Get absolute paths for debugging
          $currentDir = Get-Location
          $absoluteInstallerDir = Join-Path $currentDir $installerDir
          Write-Host "Working directory: $currentDir"
          Write-Host "Absolute installer directory: $absoluteInstallerDir"

          # Create a copy of the installer script with dynamic paths
          $issTemplate = Get-Content 'packaging/inno-setup/installer.iss' -Raw
          $issTemplate = $issTemplate -replace 'AppVersion=.*', "AppVersion=$version"
          $issTemplate = $issTemplate -replace 'Source: "\.\.\\\.\.\\src\\build\\windows\\x64\\runner\\Release\\\*"', "Source: `"..\..\src\build\windows\x64\runner\${{ env.BUILD_TYPE }}\*`""
          # Use absolute path for output directory to avoid confusion
          $issTemplate = $issTemplate -replace 'OutputDir=\.\.\\\.\.\\src\\build\\windows\\installer', "OutputDir=$absoluteInstallerDir"

          # Write the modified script to a temporary file
          $tempIssFile = "packaging/inno-setup/installer_temp.iss"
          $issTemplate | Set-Content $tempIssFile

          Write-Host "Installer script configured for build type: ${{ env.BUILD_TYPE }}"

          # Check if Inno Setup is available
          $innoSetupPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $innoSetupPath)) {
            Write-Host "Inno Setup not found at expected location. Searching for ISCC.exe..."
            $innoSetupPath = Get-Command "ISCC.exe" -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Source
            if (-not $innoSetupPath) {
              Write-Host "ERROR: Inno Setup (ISCC.exe) not found"
              exit 1
            }
          }

          Write-Host "Using Inno Setup at: $innoSetupPath"
          Write-Host "Compiling installer with build type: ${{ env.BUILD_TYPE }}"

          # Compile the installer
          & "$innoSetupPath" $tempIssFile

          if ($LASTEXITCODE -eq 0) {
            # Check for the installer
            $expectedPath = "$installerDir\whph-setup.exe"
            $alternatePath = "src\build\windows\installer\whph-setup.exe"
            
            if (Test-Path $expectedPath) {
              $installerSize = [math]::Round((Get-Item $expectedPath).Length / 1MB, 1)
              Write-Host "‚úÖ Installer created successfully ($installerSize MB)"
            } elseif (Test-Path $alternatePath) {
              Move-Item $alternatePath $expectedPath
              $installerSize = [math]::Round((Get-Item $expectedPath).Length / 1MB, 1)
              Write-Host "‚úÖ Installer created successfully ($installerSize MB)"
            } else {
              Write-Host "‚ùå Installer creation failed - file not found"
              exit 1
            }
          } else {
            Write-Host "ERROR: Installer creation failed with exit code: $LASTEXITCODE"
            exit 1
          }

          # Clean up temporary file
          if (Test-Path $tempIssFile) {
            Remove-Item $tempIssFile
          }

      - name: Get application version
        id: app_version
        uses: ./.github/actions/get-app-version

      - name: Upload Windows build artifact (Portable)
        uses: ./.github/actions/upload-build-artifact
        with:
          artifact-name: windows-portable
          artifact-path: src\build\windows\x64\runner\${{ env.BUILD_TYPE }}\
          app-version: ${{ steps.app_version.outputs.version }}

      - name: Upload Windows Installer
        uses: ./.github/actions/upload-build-artifact
        with:
          artifact-name: windows-installer
          artifact-path: src\build\windows\installer\whph-setup.exe
          app-version: ${{ steps.app_version.outputs.version }}
          compression-level: "0"

      - name: Verify installer artifact exists
        run: |
          $installerPath = "src\build\windows\installer\whph-setup.exe"
          if (Test-Path $installerPath) {
            $sizeMB = [math]::Round((Get-Item $installerPath).Length / 1MB, 1)
            Write-Host "‚úÖ Installer ready for upload ($sizeMB MB)"
          } else {
            Write-Host "‚ùå Installer not found"
            exit 1
          }
