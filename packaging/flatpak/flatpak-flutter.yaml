id: me.ahmetcetinkaya.whph
runtime: org.freedesktop.Platform
runtime-version: "25.08"
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm20
command: whph
finish-args:
  # Display
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland

  # Network
  - --share=network

  # Audio
  - --socket=pulseaudio

  # Device
  - --device=dri

  # System Tray / Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=org.freedesktop.Notifications

  # Integration / Theming
  - --filesystem=xdg-config/kdeglobals:ro
  - --filesystem=xdg-config/gtk-3.0:ro
  - --filesystem=xdg-config/gtk-4.0:ro
  - --env=GSETTINGS_BACKEND=dconf
  - --talk-name=org.freedesktop.Settings

  # Window Management (Active Window Detection)
  - --talk-name=org.gnome.Shell
  - --talk-name=org.kde.KWin
  - --talk-name=org.kde.kwin.Scripting
  - --talk-name=org.freedesktop.Flatpak
modules:
  - name: perl-xml-parser
    buildsystem: simple
    cleanup:
      - "*"
    build-commands:
      - perl Makefile.PL PREFIX=/app
      - make
      - make install
    post-install:
      - chmod -R u+w /app/lib/perl5
    sources:
      - type: archive
        url: https://cpan.metacpan.org/authors/id/T/TO/TODDR/XML-Parser-2.44.tar.gz
        sha256: 1ae9d07ee9c35326b3d9aad56eae71a6730a73a116b9fe9e8a4758b7cc033216

  - shared-modules/libayatana-appindicator/libayatana-appindicator-gtk3.json

  - name: whph
    buildsystem: simple
    build-options:
      arch:
        x86_64:
          env:
            BUNDLE_PATH: src/build/linux/x64/release/bundle
        aarch64:
          env:
            BUNDLE_PATH: src/build/linux/arm64/release/bundle
      append-path: /usr/lib/sdk/llvm20/bin:/run/build/whph/flutter/bin
      prepend-ld-library-path: /usr/lib/sdk/llvm20/lib
      env:
        PUB_CACHE: /run/build/whph/.pub-cache
    build-commands:
      # Build Process
      - cd src && flutter pub run build_runner build --delete-conflicting-outputs
      - cd src && flutter build linux --release --no-pub

      # App Bundle Installation
      # Install to /app/lib/whph to keep relative paths for Flutter engine
      - mkdir -p /app/lib/whph
      - install -D $BUNDLE_PATH/whph /app/lib/whph/whph
      - cp -r $BUNDLE_PATH/lib /app/lib/whph/
      - mkdir -p /app/lib/whph/data
      - cp -r $BUNDLE_PATH/data/flutter_assets /app/lib/whph/data/flutter_assets
      - install -D $BUNDLE_PATH/data/icudtl.dat /app/lib/whph/data/icudtl.dat

      # Create symlink in /app/bin
      - mkdir -p /app/bin
      - ln -sf /app/lib/whph/whph /app/bin/whph

      # Desktop & D-Bus Integration
      - install -D $BUNDLE_PATH/share/applications/whph.desktop /app/share/applications/me.ahmetcetinkaya.whph.desktop
      - desktop-file-edit --set-icon=me.ahmetcetinkaya.whph --set-key=Exec --set-value='/app/bin/whph %U' --remove-key=Version --remove-category=Productivity --remove-category=TimeManagement /app/share/applications/me.ahmetcetinkaya.whph.desktop
      - install -D $BUNDLE_PATH/share/dbus-1/services/whph.service /app/share/dbus-1/services/me.ahmetcetinkaya.whph.service

      # Icons & Assets - Install pre-resized icons
      - |
        for size in 16 22 24 32 48 64 128 256 512; do
          install -D src/lib/core/domain/shared/assets/images/whph-${size}.png /app/share/icons/hicolor/${size}x${size}/apps/me.ahmetcetinkaya.whph.png
          install -D src/lib/core/domain/shared/assets/images/whph_logo_fg-${size}.png /app/share/icons/hicolor/${size}x${size}/apps/me.ahmetcetinkaya.whph.default.png
          install -D src/lib/core/domain/shared/assets/images/whph_logo_fg_play-${size}.png /app/share/icons/hicolor/${size}x${size}/apps/me.ahmetcetinkaya.whph.play.png
          install -D src/lib/core/domain/shared/assets/images/whph_logo_fg_pause-${size}.png /app/share/icons/hicolor/${size}x${size}/apps/me.ahmetcetinkaya.whph.pause.png
        done

      # Metadata & Metainfo
      - install -D packaging/flatpak/flathub/me.ahmetcetinkaya.whph.metainfo.xml /app/share/metainfo/me.ahmetcetinkaya.whph.metainfo.xml

    sources:
      - type: git
        url: https://github.com/ahmet-cetinkaya/whph.git
        tag: v0.22.1
      - type: git
        url: https://github.com/flutter/flutter.git
        tag: 3.32.0
        dest: flutter
